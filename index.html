<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle KM Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            min-height: 100vh;
        }
        .upload-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 50px;
        }
        .highlight-total { background-color: #e3f2fd; }
        .highlight-cost { background-color: #fce4ec; }
        .download-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-container">
            <h3 class="text-center mb-4">Automating Data Feeding</h3>
            
            <div class="drop-zone border rounded p-5 text-center mb-4" 
                 id="dropZone" 
                 ondragover="handleDragOver(event)" 
                 ondrop="handleDrop(event)">
                <p>Drag and drop Excel file here or</p>
                <input type="file" id="fileInput" accept=".xlsx, .xls" hidden>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    Browse Files
                </button>
            </div>

            <div id="previewSection" class="preview-table mt-4"></div>
        </div>
    </div>

    <!-- Include SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
    <script>
        const input = document.getElementById('fileInput');
        const preview = document.getElementById('previewSection');
        const RATE_PER_KM = 20;
        let processedData = [];

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleDrop(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) readFile(file);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(processedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Processed Data");
            XLSX.writeFile(wb, 'processed_data.xlsx');
        }

        function readFile(file) {
            readXlsxFile(file).then((rows) => {
                const headers = rows[0];
                const dataRows = rows.slice(1);
                
                const openingIdx = headers.indexOf('OPENING KM');
                const closingIdx = headers.indexOf('CLOSING KM');

                if (openingIdx === -1 || closingIdx === -1) {
                    preview.innerHTML = `<div class="alert alert-danger">Required columns not found!</div>`;
                    return;
                }

                // Reset processed data
                processedData = [];
                let grandTotalKm = 0;
                let grandTotalCost = 0;

                // Create table structure
                const table = document.createElement('table');
                table.className = 'table table-bordered table-hover';
                
                // Create header row
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                [...headers, 'TOTAL KM', 'COSTING'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Create table body
                const tbody = document.createElement('tbody');

                dataRows.forEach(rowData => {
                    const tr = document.createElement('tr');
                    const opening = parseFloat(rowData[openingIdx]);
                    const closing = parseFloat(rowData[closingIdx]);
                    const totalKm = closing - opening;
                    const isValid = !isNaN(totalKm) && totalKm >= 0;
                    
                    // Original columns
                    rowData.forEach(cell => {
                        const td = tr.insertCell();
                        td.textContent = cell;
                    });

                    // Total KM column
                    const totalKmCell = tr.insertCell();
                    totalKmCell.textContent = isValid ? totalKm.toFixed(2) : 'Invalid';
                    totalKmCell.className = 'highlight-total';

                    // Costing column
                    const costCell = tr.insertCell();
                    let cost = 0;
                    if (isValid) {
                        cost = totalKm * RATE_PER_KM;
                        costCell.textContent = `â‚¹${cost.toFixed(2)}`;
                        grandTotalKm += totalKm;
                        grandTotalCost += cost;
                    } else {
                        costCell.textContent = 'Invalid';
                    }
                    costCell.className = 'highlight-cost';

                    // Store processed data for export
                    const rowObject = {};
                    headers.forEach((header, index) => {
                        rowObject[header] = rowData[index];
                    });
                    rowObject['TOTAL KM'] = isValid ? totalKm : 'Invalid';
                    rowObject['COSTING'] = isValid ? cost : 'Invalid';
                    processedData.push(rowObject);

                    tbody.appendChild(tr);
                });

                // Add grand total row
                const footerRow = document.createElement('tr');
                footerRow.className = 'table-primary';
                footerRow.innerHTML = `
                    <td colspan="${headers.length}" class="text-end fw-bold">Grand Total:</td>
                    <td class="highlight-total">${grandTotalKm.toFixed(2)}</td>
                    <td class="highlight-cost">â‚¹${grandTotalCost.toFixed(2)}</td>
                `;
                tbody.appendChild(footerRow);

                table.appendChild(tbody);
                preview.innerHTML = '';
                preview.appendChild(table);

                // Add download button
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.innerHTML = 'ðŸ“¥ Download Updated Excel';
                downloadBtn.onclick = exportToExcel;
                preview.appendChild(downloadBtn);
            });
        }

        input.addEventListener('change', (e) => readFile(e.target.files[0]));
    </script>
</body>
</html>
